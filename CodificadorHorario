<?php

$id_profesor = isset($_POST['id_profesor']) ? (int) $_POST['id_profesor'] : 0;
$horarioDias = $_POST['horarioDias'] ?? [];
$horarioHoras = $_POST['horarioHoras'] ?? [];
$horarioDuraciones = $_POST['horarioDuraciones'] ?? [];
$horasSemanales = isset($_POST['horasSemanales']) ? (int) $_POST['horasSemanales'] : 0;

// Conexión BD
$host = 'localhost';  
$usuario = 'root'; 
$contrasena = '';     
$baseDeDatos = 'bristol_alumnos';  

$conn = new mysqli($host, $usuario, $contrasena, $baseDeDatos);

if ($conn->connect_error) {
    die("Conexión fallida: " . $conn->connect_error);
}
$conn->set_charset("utf8");

function convertirDiasCompletos(array $dias): array {
$diasCompletos = [
    'L' => 'Lunes',
    'M' => 'Martes',
    'X' => 'Miércoles',
    'J' => 'Jueves',
    'V' => 'Viernes',
    'S' => 'Sábado',
    'D' => 'Domingo'
    ];

return array_map(fn($dia) => $diasCompletos[$dia] ?? $dia, $dias);
}

function convertirHorasSemanalesAMediasHoras(int $horas): int {
    return $horas * 2;
}

function verificarIdProfesor(int $id_profesor, mysqli $conn): bool {
$query = "SELECT id_profesor FROM profesores WHERE id_profesor = ?";
$stmt = $conn->prepare($query);
$stmt->bind_param("i", $id_profesor);
$stmt->execute();
$stmt->store_result();
$existe = $stmt->num_rows > 0;
$stmt->close();
return $existe;
}

function guardarHorarioEnBD(int $id_profesor, array $dias, array $horas, array $duraciones, int $horasSemanales, mysqli $conn): void {
    if (!verificarIdProfesor($id_profesor, $conn)) {
        echo "Error: El id_profesor no existe.";
        return;
    }

$diasJson = json_encode(convertirDiasCompletos($dias));
$horasJson = json_encode($horas);
$duracionesJson = json_encode($duraciones);
$horasEnMediasHoras = convertirHorasSemanalesAMediasHoras($horasSemanales);

$query = "INSERT INTO grupos (id_profesor, horarioDias, horarioHoras, horarioDuraciones, horasSemanales) 
          VALUES (?, ?, ?, ?, ?)";
// Los "?" son como si fuesen id_profesor, horarioDias, etc    
$stmt = $conn->prepare($query);
$stmt->bind_param("isssi", $id_profesor, $diasJson, $horasJson, $duracionesJson, $horasEnMediasHoras);

if ($stmt->execute()) {
    echo "Horario guardado con éxito.";
} else {
    echo "Error al guardar el horario: " . $stmt->error;
}

$stmt->close();
}

// Ejecuta el guardado
guardarHorarioEnBD($id_profesor, $horarioDias, $horarioHoras, $horarioDuraciones, $horasSemanales, $conn);

$conn->close();
?>
